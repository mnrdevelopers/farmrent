<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - FarmRent</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --farm-green: #2B5C2B;
            --earth-brown: #8B4513;
            --sun-yellow: #F2C14E;
            --accent-red: #D0614C;
            --clean-white: #F7F7F7;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(180deg, var(--farm-green), #1e4a1e);
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
            padding-top: 20px;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h3 {
            color: var(--sun-yellow);
            font-weight: 700;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        
        .nav-link.active {
            background: var(--sun-yellow);
            color: var(--farm-green);
            font-weight: 600;
        }
        
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Main Content Styles */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            color: var(--farm-green);
            font-weight: 700;
        }
        
        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            border: none;
            height: 100%;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--farm-green);
        }
        
        .card-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Stats Cards Colors */
        .card-earnings .card-icon {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .card-orders .card-icon {
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
        }
        
        .card-equipment .card-icon {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
            color: white;
        }
        
        .card-rating .card-icon {
            background: linear-gradient(135deg, #9C27B0, #6A1B9A);
            color: white;
        }
        
        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .table th {
            background-color: var(--farm-green);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #FFF3CD;
            color: #856404;
        }
        
        .status-approved {
            background-color: #D4EDDA;
            color: #155724;
        }
        
        .status-rented {
            background-color: #D1ECF1;
            color: #0C5460;
        }
        
        .status-available {
            background-color: #E2E3E5;
            color: #383D41;
        }
        
        .order-status-pending {
            background-color: #FFF3CD;
            color: #856404;
        }
        
        .order-status-active {
            background-color: #D1ECF1;
            color: #0C5460;
        }
        
        .order-status-completed {
            background-color: #D4EDDA;
            color: #155724;
        }
        
        .order-status-cancelled {
            background-color: #F8D7DA;
            color: #721C24;
        }
        
        /* Button Styles */
        .btn-primary {
            background-color: var(--farm-green);
            border-color: var(--farm-green);
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background-color: #1e4a1e;
            border-color: #1e4a1e;
        }
        
        .btn-warning {
            background-color: var(--sun-yellow);
            border-color: var(--sun-yellow);
            color: var(--farm-green);
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .btn-outline-primary {
            color: var(--farm-green);
            border-color: var(--farm-green);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--farm-green);
            color: white;
        }
        
        /* Modal Styles */
        .modal-header {
            background-color: var(--farm-green);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            height: 100%;
        }
        
        /* Equipment Cards */
        .equipment-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            height: 100%;
        }
        
        .equipment-card:hover {
            transform: translateY(-5px);
        }
        
        .equipment-img {
            height: 200px;
            width: 100%;
            object-fit: cover;
        }
        
        .equipment-price {
            color: var(--farm-green);
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: var(--farm-green);
            color: white;
            border-color: var(--farm-green);
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .quick-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar d-none d-lg-block">
        <div class="sidebar-header">
            <h3><i class="fas fa-tractor me-2"></i>FarmRent</h3>
            <p class="text-muted mb-0" style="color: rgba(255,255,255,0.7) !important;">Seller Dashboard</p>
        </div>
        
        <nav class="nav flex-column mt-4">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="#" onclick="showSection('equipment')">
                <i class="fas fa-tools"></i> My Equipment
            </a>
            <a class="nav-link" href="#" onclick="showSection('orders')">
                <i class="fas fa-clipboard-list"></i> Orders
            </a>
            <a class="nav-link" href="#" onclick="showSection('add-equipment')">
                <i class="fas fa-plus-circle"></i> Add Equipment
            </a>
            <a class="nav-link" href="#" onclick="showSection('earnings')">
                <i class="fas fa-rupee-sign"></i> Earnings
            </a>
            <a class="nav-link" href="#" onclick="showSection('messages')">
                <i class="fas fa-envelope"></i> Messages
                <span class="badge bg-warning ms-auto" id="message-count">3</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('reviews')">
                <i class="fas fa-star"></i> Reviews
            </a>
            <a class="nav-link" href="#" onclick="showSection('profile')">
                <i class="fas fa-user-cog"></i> Profile Settings
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="d-grid">
                <button class="btn btn-warning" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Navbar -->
    <nav class="navbar navbar-dark bg-dark d-lg-none">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tractor me-2"></i>FarmRent Seller
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <!-- Mobile Sidebar Offcanvas -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="mobileSidebar">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">
                <i class="fas fa-tractor me-2"></i>FarmRent Seller
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <nav class="nav flex-column">
                <a class="nav-link text-white active" href="#" onclick="showSection('dashboard')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('equipment')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-tools me-2"></i> My Equipment
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('orders')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-clipboard-list me-2"></i> Orders
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('add-equipment')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-plus-circle me-2"></i> Add Equipment
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('earnings')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-rupee-sign me-2"></i> Earnings
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('messages')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-envelope me-2"></i> Messages
                    <span class="badge bg-warning ms-auto">3</span>
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('reviews')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-star me-2"></i> Reviews
                </a>
                <a class="nav-link text-white" href="#" onclick="showSection('profile')" data-bs-dismiss="offcanvas">
                    <i class="fas fa-user-cog me-2"></i> Profile Settings
                </a>
                <hr class="text-white">
                <button class="btn btn-warning" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navbar -->
        <nav class="navbar-custom mb-4">
            <div class="container-fluid">
                <div class="d-flex justify-content-between w-100 align-items-center">
                    <div>
                        <h4 class="mb-0" id="page-title">Seller Dashboard</h4>
                        <p class="text-muted mb-0" id="welcome-message">Welcome back!</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-bell"></i>
                                <span class="badge bg-danger" id="notification-count">2</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">Notifications</h6></li>
                                <li><a class="dropdown-item" href="#">New order received</a></li>
                                <li><a class="dropdown-item" href="#">Equipment rental request</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#">View all notifications</a></li>
                            </ul>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-2"></i>
                                <span id="seller-name">Seller</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showSection('profile')"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showSection('profile')"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="index.html"><i class="fas fa-home me-2"></i>Back to Home</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Loading Spinner -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3">Loading dashboard...</p>
        </div>

        <!-- Dashboard Section -->
        <div class="section" id="dashboard-section">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-earnings">
                        <div class="card-icon">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <h3 class="card-value" id="total-earnings">₹0</h3>
                        <p class="card-label">Total Earnings</p>
                        <small class="text-success"><i class="fas fa-arrow-up me-1"></i> Loading...</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-orders">
                        <div class="card-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h3 class="card-value" id="total-orders">0</h3>
                        <p class="card-label">Total Orders</p>
                        <small class="text-success"><i class="fas fa-arrow-up me-1"></i> Loading...</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-equipment">
                        <div class="card-icon">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <h3 class="card-value" id="total-equipment">0</h3>
                        <p class="card-label">Equipment Listed</p>
                        <small class="text-success"><i class="fas fa-check-circle me-1"></i> Loading...</small>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="dashboard-card card-rating">
                        <div class="card-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <h3 class="card-value" id="seller-rating">0.0</h3>
                        <p class="card-label">Average Rating</p>
                        <small class="text-success"><i class="fas fa-star me-1"></i> Loading...</small>
                    </div>
                </div>
            </div>

            <!-- Charts and Quick Actions -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-3">Earnings Overview</h5>
                        <canvas id="earningsChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="chart-container">
                        <h5 class="mb-3">Quick Actions</h5>
                        <div class="quick-actions mt-3">
                            <button class="action-btn" onclick="showSection('add-equipment')">
                                <i class="fas fa-plus fa-2x mb-2"></i>
                                <div>Add Equipment</div>
                            </button>
                            <button class="action-btn" onclick="showSection('orders')">
                                <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                <div>View Orders</div>
                            </button>
                            <button class="action-btn" onclick="showSection('messages')">
                                <i class="fas fa-envelope fa-2x mb-2"></i>
                                <div>Messages</div>
                            </button>
                            <button class="action-btn" onclick="showSection('profile')">
                                <i class="fas fa-cog fa-2x mb-2"></i>
                                <div>Settings</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="row">
                <div class="col-12">
                    <div class="table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Recent Orders</h5>
                            <a href="#" class="btn btn-outline-primary btn-sm" onclick="showSection('orders')">View All</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Equipment</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-orders-table">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm text-primary"></div>
                                            <p class="mt-2 mb-0">Loading orders...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Equipment Section -->
        <div class="section" id="equipment-section" style="display: none;">
            <div class="page-header">
                <h1>My Equipment</h1>
                <p class="text-muted">Manage your listed farming equipment</p>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button class="btn btn-primary" onclick="showSection('add-equipment')">
                                <i class="fas fa-plus me-2"></i>Add New Equipment
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" placeholder="Search equipment..." id="equipment-search" onkeyup="searchEquipment()">
                            <select class="form-select" style="width: auto;" id="equipment-filter" onchange="filterEquipment()">
                                <option value="all">All Status</option>
                                <option value="available">Available</option>
                                <option value="rented">Rented</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" id="equipment-grid">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-3">Loading equipment...</p>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="section" id="orders-section" style="display: none;">
            <div class="page-header">
                <h1>Orders</h1>
                <p class="text-muted">Manage all rental orders</p>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" onclick="filterOrders('all')">All</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterOrders('pending')">Pending</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterOrders('active')">Active</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterOrders('completed')">Completed</button>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control" id="order-date-filter" onchange="filterByDate()">
                                <button class="btn btn-primary" onclick="exportOrders()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Equipment</th>
                                        <th>Customer</th>
                                        <th>Rental Period</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm text-primary"></div>
                                            <p class="mt-2 mb-0">Loading orders...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Equipment Section -->
        <div class="section" id="add-equipment-section" style="display: none;">
            <div class="page-header">
                <h1>Add New Equipment</h1>
                <p class="text-muted">List your farming equipment for rent</p>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="table-container">
                        <form id="add-equipment-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="equipment-name" class="form-label">Equipment Name *</label>
                                    <input type="text" class="form-control" id="equipment-name" placeholder="e.g., John Deere Tractor" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="equipment-category" class="form-label">Category *</label>
                                    <select class="form-select" id="equipment-category" required>
                                        <option value="">Select Category</option>
                                        <option value="tractor">Tractor</option>
                                        <option value="harvester">Harvester</option>
                                        <option value="cultivator">Cultivator</option>
                                        <option value="drone">Agricultural Drone</option>
                                        <option value="spray">Spray Machine</option>
                                        <option value="crane">Crane</option>
                                        <option value="jcb">JCB</option>
                                        <option value="grass-cutter">Grass Cutter</option>
                                        <option value="trolley">Trolley</option>
                                        <option value="water-tanker">Water Tanker</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <!-- UPDATED: Changed from daily-price to acre-price and label to 'Per Acre' -->
                                <div class="col-md-6 mb-3">
                                    <label for="acre-price" class="form-label">Per Acre Rental Price (₹) *</label>
                                    <input type="number" class="form-control" id="acre-price" placeholder="e.g., 2500" min="0" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="hourly-price" class="form-label">Hourly Rental Price (₹) *</label>
                                    <input type="number" class="form-control" id="hourly-price" placeholder="e.g., 350" min="0" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="equipment-description" class="form-label">Description *</label>
                                <textarea class="form-control" id="equipment-description" rows="3" placeholder="Describe your equipment, features, and condition" required></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="equipment-location" class="form-label">Location *</label>
                                    <input type="text" class="form-control" id="equipment-location" placeholder="City, State" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="equipment-quantity" class="form-label">Quantity Available *</label>
                                    <input type="number" class="form-control" id="equipment-quantity" value="1" min="1" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Upload Images *</label>
                                <div class="border rounded p-3 text-center" id="image-upload-area" onclick="document.getElementById('image-upload').click()" style="cursor: pointer;">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p>Click to upload images or drag & drop</p>
                                    <input type="file" class="form-control d-none" id="image-upload" multiple accept="image/*">
                                    <div class="mt-3" id="image-preview"></div>
                                </div>
                                <small class="text-muted">Upload clear images of your equipment. First image will be used as thumbnail.</small>
                            </div>

                            <div class="mb-3">
                                <label for="equipment-specs" class="form-label">Specifications (Optional)</label>
                                <div class="row g-2" id="specs-container">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control mb-2" placeholder="e.g., Brand">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control mb-2" placeholder="e.g., John Deere">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSpecField()">
                                    <i class="fas fa-plus me-1"></i>Add More Specifications
                                </button>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="terms-agree" required>
                                <label class="form-check-label" for="terms-agree">
                                    I confirm that all information provided is accurate and I agree to the <a href="#" class="text-decoration-none">Seller Terms</a>
                                </label>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" id="submit-equipment-btn">
                                    <i class="fas fa-save me-2"></i>List Equipment
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="showSection('equipment')">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="table-container">
                        <h5 class="mb-3">Listing Tips</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Use clear, high-quality images
                            </li>
                            <li class="list-group-item">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Be honest about equipment condition
                            </li>
                            <li class="list-group-item">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Set competitive pricing
                            </li>
                            <li class="list-group-item">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Include all relevant specifications
                            </li>
                            <li class="list-group-item">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                Update availability regularly
                            </li>
                        </ul>
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Equipment listing will be reviewed by admin before going live.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Earnings Section -->
        <div class="section" id="earnings-section" style="display: none;">
            <div class="page-header">
                <h1>Earnings & Analytics</h1>
                <p class="text-muted">Track your earnings and performance</p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="table-container">
                        <h5 class="mb-3">Earnings Summary</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="dashboard-card">
                                    <h6 class="text-muted">This Month</h6>
                                    <h3 class="card-value" id="month-earnings">₹0</h3>
                                    <small class="text-success" id="month-growth">Loading...</small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="dashboard-card">
                                    <h6 class="text-muted">Last Month</h6>
                                    <h3 class="card-value" id="last-month-earnings">₹0</h3>
                                    <small class="text-muted">Previous period</small>
                                </div>
                            </div>
                        </div>
                        <canvas id="detailedEarningsChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="table-container">
                        <h5 class="mb-3">Top Earning Equipment</h5>
                        <div id="top-equipment-list">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <p class="mt-2 mb-0">Loading data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div class="section" id="messages-section" style="display: none;">
            <div class="page-header">
                <h1>Messages</h1>
                <p class="text-muted">Communicate with customers</p>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="table-container" style="height: 600px; overflow-y: auto;">
                        <h5 class="mb-3">Conversations</h5>
                        <div class="list-group" id="conversations-list">
                            <!-- Removed mock data and replaced with a loading state -->
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <p class="mt-2 mb-0">Loading conversations...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="table-container" style="height: 600px; display: flex; flex-direction: column;">
                        <div id="chat-header" class="mb-3">
                            <h5>Select a conversation</h5>
                        </div>
                        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Select a conversation to view messages</p>
                            </div>
                        </div>
                        <div id="chat-input" style="display: none;">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Type your message..." id="message-input">
                                <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="section" id="reviews-section" style="display: none;">
            <div class="page-header">
                <h1>Customer Reviews</h1>
                <p class="text-muted">View and respond to customer feedback</p>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="table-container text-center">
                        <h1 class="display-1 text-warning" id="average-rating">0.0</h1>
                        <div class="mb-2">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                        </div>
                        <p class="text-muted" id="total-reviews">0 reviews</p>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="table-container">
                        <h5 class="mb-3">Recent Reviews</h5>
                        <div id="reviews-list">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <p class="mt-2 mb-0">Loading reviews...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="section" id="profile-section" style="display: none;">
            <div class="page-header">
                <h1>Profile Settings</h1>
                <p class="text-muted">Manage your seller account</p>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="table-container">
                        <form id="profile-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="profile-name" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="profile-name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="profile-email" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="profile-email" required readonly>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="profile-phone" class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" id="profile-phone" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="profile-business" class="form-label">Business Name *</label>
                                    <input type="text" class="form-control" id="profile-business" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="profile-address" class="form-label">Business Address *</label>
                                <textarea class="form-control" id="profile-address" rows="3" required></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="profile-gst" class="form-label">GST Number</label>
                                    <input type="text" class="form-control" id="profile-gst">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="profile-city" class="form-label">City *</label>
                                    <input type="text" class="form-control" id="profile-city" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="profile-bio" class="form-label">Business Description</label>
                                <textarea class="form-control" id="profile-bio" rows="2" placeholder="Tell customers about your business"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Profile Picture</label>
                                <div class="d-flex align-items-center gap-3">
                                    <img src="https://via.placeholder.com/100" alt="Profile" class="rounded-circle" id="profile-picture" width="100" height="100">
                                    <div>
                                        <input type="file" class="form-control d-none" id="profile-picture-upload" accept="image/*">
                                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('profile-picture-upload').click()">
                                            <i class="fas fa-upload me-2"></i>Upload New Picture
                                        </button>
                                        <small class="text-muted d-block mt-1">Recommended: Square image, max 2MB</small>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <h5 class="mb-3">Change Password</h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="current-password" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="current-password">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="new-password" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="new-password">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="confirm-password" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirm-password">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="showDeleteAccountModal()">
                                    <i class="fas fa-trash me-2"></i>Delete Account
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="table-container">
                        <h5 class="mb-3">Account Status</h5>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Verified Seller</strong>
                            <p class="mb-0 mt-1">Your account is active and verified</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Seller Since</h6>
                            <p id="join-date">Loading...</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Account Verification</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Email Verified
                                    <span class="badge bg-success" id="email-verified">Yes</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Phone Verified
                                    <span class="badge bg-success" id="phone-verified">Yes</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Business Verified
                                    <span class="badge bg-success" id="business-verified">Yes</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Need help? Contact our seller support team at <strong>support@farmrent.com</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Details Modal -->
    <div class="modal fade" id="equipmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Equipment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="equipment-modal-body">
                    <!-- Equipment details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="edit-equipment-btn">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="order-modal-body">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning: This action cannot be undone!</strong>
                    </div>
                    <p>Are you sure you want to delete your seller account? This will:</p>
                    <ul>
                        <li>Remove all your equipment listings</li>
                        <li>Cancel all pending orders</li>
                        <li>Delete your profile and business information</li>
                        <li>Remove you from the FarmRent platform</li>
                    </ul>
                    <div class="mb-3">
                        <label for="delete-confirmation" class="form-label">Type "DELETE" to confirm:</label>
                        <input type="text" class="form-control" id="delete-confirmation" placeholder="Type DELETE here">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteAccount()" id="delete-account-btn" disabled>Delete Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <!-- ADDED: Firebase Remote Config SDK for fetching ImgBB key -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-remote-config-compat.js"></script>
    <!-- REMOVED: <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script> -->
    <script src="firebase-config.js"></script>
<script>
    // Global variables
    let currentUser = null;
    let sellerData = null;
    let equipmentData = [];
    let ordersData = [];
    let earningsChart = null;
    let detailedEarningsChart = null;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', async () => {
        // Check authentication using helper function
        const authCheck = await window.firebaseHelpers.checkAuthAndRole('seller');
        
        if (!authCheck.authenticated) {
            window.location.href = 'auth.html?role=seller';
            return;
        }
        
        if (!authCheck.authorized) {
            window.location.href = 'index.html';
            return;
        }
        
        currentUser = authCheck.user;
        sellerData = authCheck.user;
        
        // Check if seller is approved
        if (sellerData.status !== 'approved') {
            window.location.href = 'seller-pending.html';
            return;
        }
        
        // Update UI with seller data
        updateSellerInfo();
        loadDashboardData();
        loadProfileData();
        
        // Hide loading spinner
        document.getElementById('loading').classList.remove('active');
    });

    // Update seller information in UI
    function updateSellerInfo() {
        if (sellerData) {
            document.getElementById('seller-name').textContent = sellerData.name || 'Seller';
            document.getElementById('welcome-message').textContent = `Welcome back, ${sellerData.name || 'Seller'}!`;
            
            if (sellerData.businessName) {
                document.getElementById('page-title').textContent = `${sellerData.businessName} - Dashboard`;
            }
        }
    }

    // Show section function
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Remove active class from all nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Show selected section
        document.getElementById(`${sectionId}-section`).style.display = 'block';
        
        // Update active nav link
        const navLink = Array.from(document.querySelectorAll('.nav-link')).find(link => 
            link.getAttribute('onclick')?.includes(sectionId)
        );
        if (navLink) {
            navLink.classList.add('active');
        }
        
        // Load section data
        switch(sectionId) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'equipment':
                loadEquipmentList();
                break;
            case 'orders':
                loadOrders();
                break;
            case 'earnings':
                loadEarningsData();
                break;
            case 'messages':
                loadMessages();
                break;
            case 'reviews':
                loadReviews();
                break;
            case 'profile':
                loadProfileData();
                break;
        }
    }

    // Load dashboard data
    async function loadDashboardData() {
        try {
            if (!currentUser) return;
            
            // Load statistics
            const stats = await calculateSellerStats();
            
            // Update stats cards
            document.getElementById('total-earnings').textContent = window.firebaseHelpers.formatCurrency(stats.totalEarnings);
            document.getElementById('total-orders').textContent = stats.totalOrders;
            document.getElementById('total-equipment').textContent = stats.totalEquipment;
            document.getElementById('seller-rating').textContent = stats.rating.toFixed(1);
            
            // Load recent orders
            await loadRecentOrders();
            
            // Initialize chart
            initializeEarningsChart();
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            window.firebaseHelpers.showAlert('Error loading dashboard data', 'danger');
        }
    }

    // Calculate seller statistics
    async function calculateSellerStats() {
        if (!currentUser) return {
            totalEarnings: 0,
            totalOrders: 0,
            totalEquipment: 0,
            rating: 0
        };
        
        try {
            // Get seller's equipment
            const equipmentSnapshot = await window.FirebaseDB.collection('equipment')
                .where('sellerId', '==', currentUser.uid)
                .get();
            
            const totalEquipment = equipmentSnapshot.size;
            
            // Get seller's orders
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const ordersCollectionRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');

            const ordersSnapshot = await ordersCollectionRef
                .where('items', 'array-contains-any', [{ sellerId: currentUser.uid }]) // Simplified query for multi-item orders
                .get();

            
            const totalOrders = ordersSnapshot.size;
            
            // Calculate total earnings
            let totalEarnings = 0;
            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                if (order.status === 'completed' || order.status === 'active') {
                    // Assuming totalAmount includes the seller's earnings share
                    totalEarnings += order.totalAmount || 0;
                }
            });
            
            // Get average rating from reviews
            const reviewsSnapshot = await window.FirebaseDB.collection('reviews')
                .where('sellerId', '==', currentUser.uid)
                .get();
            
            let totalRating = 0;
            let ratingCount = 0;
            
            reviewsSnapshot.forEach(doc => {
                const review = doc.data();
                totalRating += review.rating || 0;
                ratingCount++;
            });
            
            const rating = ratingCount > 0 ? totalRating / ratingCount : 4.0;
            
            return {
                totalEarnings,
                totalOrders,
                totalEquipment,
                rating
            };
            
        } catch (error) {
            console.error('Error calculating stats:', error);
            return {
                totalEarnings: 0,
                totalOrders: 0,
                totalEquipment: 0,
                rating: 4.0
            };
        }
    }

    // Load recent orders
    async function loadRecentOrders() {
        if (!currentUser) return;
        
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const ordersCollectionRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');
            
            // Fetch recent orders where the seller is involved (limited query for recent orders)
            // Note: For orders containing multiple items from different sellers, this simple query is insufficient. 
            // A more complex query or denormalization would be needed in a real-world scenario.
            // Temporarily fetching based on sellerId in items array, which may not be fully supported by Firestore simple queries.
            // Using a broader query and filtering locally for simplicity in this demo environment.
            
            const ordersSnapshot = await ordersCollectionRef
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get();
            
            const ordersTable = document.getElementById('recent-orders-table');
            ordersTable.innerHTML = '';
            
            ordersData = [];
            let recentOrders = [];
            
            ordersSnapshot.forEach(doc => {
                const order = { id: doc.id, ...doc.data() };
                
                // Filter orders relevant to this seller (assuming complex order object structure)
                if (order.sellerIds && order.sellerIds.includes(currentUser.uid)) {
                    ordersData.push(order);
                    recentOrders.push(order);
                }
            });

            recentOrders = recentOrders.slice(0, 5); // Limit to 5 for dashboard
            
            if (recentOrders.length === 0) {
                ordersTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
                            <p>No recent orders found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            recentOrders.forEach(order => {
                const row = createOrderRow(order);
                ordersTable.innerHTML += row;
            });
            
        } catch (error) {
            console.error('Error loading recent orders:', error);
            ordersTable.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading orders
                    </td>
                </tr>
            `;
        }
    }

    // Create order row HTML
    function createOrderRow(order) {
        const statusClass = `order-status-${order.status || 'pending'}`;
        const statusText = (order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1);
        const date = window.firebaseHelpers.formatDate(order.createdAt);
        
        // Use consolidated equipment name if available, otherwise default to first item's name
        const equipmentName = order.equipmentNames.split(',')[0] || order.items[0]?.name || 'Equipment';

        return `
            <tr>
                <td>#${order.id.substring(0, 8)}</td>
                <td>${equipmentName}</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>${date}</td>
                <td>${window.firebaseHelpers.formatCurrency(order.totalAmount || 0)}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${order.status === 'pending' ? `
                        <button class="btn btn-sm btn-success ms-1" onclick="updateOrderStatus('${order.id}', 'approved')">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    }

    // Initialize earnings chart
    function initializeEarningsChart() {
        const ctx = document.getElementById('earningsChart').getContext('2d');
        
        if (earningsChart) {
            earningsChart.destroy();
        }
        
        // REMOVED: Mock data. Chart will initialize with empty data and be populated by loadEarningsData.
        earningsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Monthly Earnings (₹)',
                    data: [0, 0, 0, 0, 0, 0], 
                    borderColor: '#2B5C2B',
                    backgroundColor: 'rgba(43, 92, 43, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Load equipment list
    async function loadEquipmentList() {
        if (!currentUser) return;
        
        try {
            const equipmentSnapshot = await window.FirebaseDB.collection('equipment')
                .where('sellerId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();
            
            const equipmentGrid = document.getElementById('equipment-grid');
            equipmentGrid.innerHTML = '';
            
            if (equipmentSnapshot.empty) {
                equipmentGrid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-tractor fa-3x text-muted mb-3"></i>
                        <h4>No equipment listed yet</h4>
                        <p class="text-muted">Start by adding your first equipment</p>
                        <button class="btn btn-primary mt-2" onclick="showSection('add-equipment')">
                            <i class="fas fa-plus me-2"></i>Add Equipment
                        </button>
                    </div>
                `;
                return;
            }
            
            equipmentData = [];
            equipmentSnapshot.forEach(doc => {
                const equipment = { id: doc.id, ...doc.data() };
                equipmentData.push(equipment);
                const card = createEquipmentCard(equipment);
                equipmentGrid.innerHTML += card;
            });
            
        } catch (error) {
            console.error('Error loading equipment:', error);
            window.firebaseHelpers.showAlert('Error loading equipment list', 'danger');
            equipmentGrid.innerHTML = `
                <div class="col-12 text-center py-5 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4>Error loading equipment</h4>
                    <p>Please try again later</p>
                </div>
            `;
        }
    }

    // Create equipment card HTML
    function createEquipmentCard(equipment) {
        const statusClass = equipment.availability ? 'status-available' : 'status-rented';
        const statusText = equipment.availability ? 'Available' : 'Rented';
        const imageUrl = equipment.images && equipment.images[0] ? equipment.images[0] : 'https://via.placeholder.com/300x200/2B5C2B/FFFFFF?text=Equipment';
        
        return `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="equipment-card">
                    <img src="${imageUrl}" class="equipment-img" alt="${equipment.name}" style="height: 200px; object-fit: cover;">
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="mb-0">${equipment.name}</h5>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <p class="text-muted small mb-2">${equipment.category || 'Equipment'}</p>
                        <div class="equipment-price mb-3">
                            ${window.firebaseHelpers.formatCurrency(equipment.pricePerAcre || 0)}/acre
                            <small class="text-muted">or ${window.firebaseHelpers.formatCurrency(equipment.pricePerHour || 0)}/hour</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewEquipmentDetails('${equipment.id}')">
                                <i class="fas fa-eye me-1"></i>View
                            </button>
                            <button class="btn btn-sm btn-warning flex-fill" onclick="editEquipment('${equipment.id}')">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteEquipment('${equipment.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Search equipment
    function searchEquipment() {
        const searchTerm = document.getElementById('equipment-search').value.toLowerCase();
        const filteredEquipment = equipmentData.filter(equipment => 
            equipment.name.toLowerCase().includes(searchTerm) ||
            equipment.category.toLowerCase().includes(searchTerm) ||
            equipment.description.toLowerCase().includes(searchTerm)
        );
        
        displayFilteredEquipment(filteredEquipment);
    }

    // Filter equipment
    function filterEquipment() {
        const filterValue = document.getElementById('equipment-filter').value;
        let filteredEquipment = equipmentData;
        
        if (filterValue === 'available') {
            filteredEquipment = equipmentData.filter(e => e.availability === true);
        } else if (filterValue === 'rented') {
            filteredEquipment = equipmentData.filter(e => e.availability === false);
        } else if (filterValue === 'maintenance') {
            filteredEquipment = equipmentData.filter(e => e.status === 'maintenance');
        }
        
        displayFilteredEquipment(filteredEquipment);
    }

    // Display filtered equipment
    function displayFilteredEquipment(equipmentList) {
        const equipmentGrid = document.getElementById('equipment-grid');
        equipmentGrid.innerHTML = '';
        
        if (equipmentList.length === 0) {
            equipmentGrid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4>No equipment found</h4>
                    <p class="text-muted">Try changing your search criteria</p>
                </div>
            `;
            return;
        }
        
        equipmentList.forEach(equipment => {
            const card = createEquipmentCard(equipment);
            equipmentGrid.innerHTML += card;
        });
    }

    // Load orders
    async function loadOrders() {
        if (!currentUser) return;
        
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const ordersCollectionRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');
            
            const ordersSnapshot = await ordersCollectionRef
                .orderBy('createdAt', 'desc')
                .get();
            
            const ordersTable = document.getElementById('orders-table');
            ordersTable.innerHTML = '';
            
            ordersData = [];
            
            ordersSnapshot.forEach(doc => {
                const order = { id: doc.id, ...doc.data() };
                
                 // Filter orders relevant to this seller
                if (order.sellerIds && order.sellerIds.includes(currentUser.uid)) {
                    ordersData.push(order);
                    const row = createFullOrderRow(order);
                    ordersTable.innerHTML += row;
                }
            });

            if (ordersData.length === 0) {
                ordersTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
                            <p>No orders found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
        } catch (error) {
            console.error('Error loading orders:', error);
            window.firebaseHelpers.showAlert('Error loading orders', 'danger');
        }
    }

    // Create full order row for orders section
    function createFullOrderRow(order) {
        const statusClass = `order-status-${order.status || 'pending'}`;
        const statusText = (order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1);
        
        // Extract rental details from the first item (simplification)
        const rentalPeriod = order.items && order.items.length > 0 
            ? `${order.items[0].rentalValue} ${order.items[0].rentalType === 'acre' ? 'Acre(s)' : 'Hour(s)'}`
            : 'N/A';
        
        // Use consolidated equipment name if available, otherwise default to first item's name
        const equipmentName = order.equipmentNames.split(',')[0] || order.items[0]?.name || 'Equipment';

        return `
            <tr>
                <td>#${order.id.substring(0, 8)}</td>
                <td>${equipmentName}</td>
                <td>${order.customerName || 'N/A'}<br><small class="text-muted">${order.customerPhone || ''}</small></td>
                <td>${rentalPeriod}</td>
                <td>${window.firebaseHelpers.formatCurrency(order.totalAmount || 0)}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${order.status === 'pending' ? `
                        <button class="btn btn-sm btn-success ms-1" onclick="updateOrderStatus('${order.id}', 'approved')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger ms-1" onclick="updateOrderStatus('${order.id}', 'cancelled')">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                    ${order.status === 'active' ? `
                        <button class="btn btn-sm btn-primary ms-1" onclick="updateOrderStatus('${order.id}', 'completed')">
                            <i class="fas fa-flag-checkered"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    }

    // Filter orders
    function filterOrders(status) {
        const rows = document.querySelectorAll('#orders-table tr');
        rows.forEach(row => {
            if (row.querySelector('td')) {
                const statusBadge = row.querySelector('.status-badge');
                if (status === 'all' || (statusBadge && statusBadge.textContent.toLowerCase().includes(status))) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
        
        // Update active button
        document.querySelectorAll('#orders-section .btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // Check if the event target is valid before adding active class
        if (event && event.target && event.target.classList.contains('btn')) {
            event.target.classList.add('active');
        }
    }

    // Filter by date (NOTE: This filter is based on creation date, not rental period)
    function filterByDate() {
        const dateFilter = document.getElementById('order-date-filter').value;
        if (!dateFilter) {
            // If filter is cleared, show all
            loadOrders();
            return;
        }
        
        const filterDate = new Date(dateFilter).toLocaleDateString();
        
        const filteredOrders = ordersData.filter(order => {
            const orderDate = order.createdAt ? window.firebaseHelpers.formatDate(order.createdAt) : '';
            return orderDate === filterDate;
        });

        const ordersTable = document.getElementById('orders-table');
        ordersTable.innerHTML = '';

        if (filteredOrders.length === 0) {
            ordersTable.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-search-minus fa-2x text-muted mb-3"></i>
                        <p>No orders found for this date.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        filteredOrders.forEach(order => {
            const row = createFullOrderRow(order);
            ordersTable.innerHTML += row;
        });
    }

    // Export orders
    function exportOrders() {
        window.firebaseHelpers.showAlert('Export feature coming soon!', 'info');
    }

    // Add equipment form submission
    document.getElementById('add-equipment-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentUser) {
            window.firebaseHelpers.showAlert('Please login again', 'danger');
            return;
        }
        
        const submitBtn = document.getElementById('submit-equipment-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        submitBtn.disabled = true;
        
        try {
            // Get form values (UPDATED to use 'acre-price' instead of 'daily-price')
            const equipmentData = {
                name: document.getElementById('equipment-name').value,
                category: document.getElementById('equipment-category').value,
                pricePerAcre: parseFloat(document.getElementById('acre-price').value), // UPDATED ID
                pricePerHour: parseFloat(document.getElementById('hourly-price').value),
                description: document.getElementById('equipment-description').value,
                location: document.getElementById('equipment-location').value,
                quantity: parseInt(document.getElementById('equipment-quantity').value),
                sellerId: currentUser.uid,
                sellerName: sellerData.name,
                businessName: sellerData.businessName || '',
                availability: true,
                status: 'pending', // Needs admin approval
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                images: []
            };
            
            // Add specifications
            const specs = {};
            const specInputs = document.querySelectorAll('#specs-container input');
            for (let i = 0; i < specInputs.length; i += 2) {
                // Ensure spec name and value are present
                if (specInputs[i].value && specInputs[i + 1]?.value) {
                    specs[specInputs[i].value] = specInputs[i + 1].value;
                }
            }
            equipmentData.specifications = specs;
            
            // Save initial document to Firestore
            const docRef = await window.FirebaseDB.collection('equipment').add(equipmentData);
            
            // Upload images using the new ImgBB helper
            const imageFiles = document.getElementById('image-upload').files;
            if (imageFiles.length > 0) {
                const imageUrls = [];
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    // The path argument is still passed but ignored in the new helper
                    const downloadURL = await window.firebaseHelpers.uploadFile(
                        `equipment/${docRef.id}`, // Path is ignored by new helper
                        file
                    );
                    imageUrls.push(downloadURL);
                }
                
                // Update equipment with image URLs
                await window.FirebaseDB.collection('equipment').doc(docRef.id).update({
                    images: imageUrls
                });
            }
            
            window.firebaseHelpers.showAlert('Equipment added successfully! Waiting for admin approval.', 'success');
            
            // Reset form
            this.reset();
            document.getElementById('image-preview').innerHTML = '';
            
            // Go back to equipment list
            setTimeout(() => {
                showSection('equipment');
            }, 2000);
            
        } catch (error) {
            console.error('Error adding equipment:', error);
            window.firebaseHelpers.showAlert('Error adding equipment: ' + error.message, 'danger');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // Add specification field
    function addSpecField() {
        const specsContainer = document.getElementById('specs-container');
        const newRow = document.createElement('div');
        newRow.className = 'row g-2';
        newRow.innerHTML = `
            <div class="col-md-6">
                <input type="text" class="form-control mb-2" placeholder="Specification name">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control mb-2" placeholder="Specification value">
            </div>
        `;
        specsContainer.appendChild(newRow);
    }

    // View equipment details
    async function viewEquipmentDetails(equipmentId) {
        try {
            const doc = await window.FirebaseDB.collection('equipment').doc(equipmentId).get();
            if (doc.exists) {
                const equipment = doc.data();
                
                // Create modal content
                const modalBody = `
                    <div class="row">
                        <div class="col-md-6">
                            <img src="${equipment.images && equipment.images[0] ? equipment.images[0] : 'https://via.placeholder.com/500x300'}" 
                                 class="img-fluid rounded mb-3" alt="${equipment.name}" style="max-height: 300px; object-fit: cover;">
                            ${equipment.images && equipment.images.length > 1 ? `
                                <div class="d-flex gap-2">
                                    ${equipment.images.slice(1).map(img => `
                                        <img src="${img}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-6">
                            <h4>${equipment.name}</h4>
                            <p class="text-muted">${equipment.category}</p>
                            <div class="mb-3">
                                <h5 class="text-primary">${window.firebaseHelpers.formatCurrency(equipment.pricePerAcre)}/acre</h5>
                                <small class="text-muted">or ${window.firebaseHelpers.formatCurrency(equipment.pricePerHour)}/hour</small>
                            </div>
                            <p>${equipment.description}</p>
                            <div class="mb-2">
                                <strong>Location:</strong> ${equipment.location}
                            </div>
                            <div class="mb-2">
                                <strong>Quantity Available:</strong> ${equipment.quantity || 1}
                            </div>
                            <div class="mb-3">
                                <strong>Status:</strong> 
                                <span class="status-badge ${equipment.availability ? 'status-available' : 'status-rented'}">
                                    ${equipment.availability ? 'Available' : 'Rented'}
                                </span>
                            </div>
                            ${equipment.specifications && Object.keys(equipment.specifications).length > 0 ? `
                                <div class="mb-3">
                                    <strong>Specifications:</strong>
                                    <ul class="list-unstyled">
                                        ${Object.entries(equipment.specifications).map(([key, value]) => `
                                            <li><strong>${key}:</strong> ${value}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('equipment-modal-body').innerHTML = modalBody;
                document.getElementById('edit-equipment-btn').onclick = () => editEquipment(equipmentId);
                const modal = new bootstrap.Modal(document.getElementById('equipmentModal'));
                modal.show();
            }
        } catch (error) {
            console.error('Error viewing equipment:', error);
            window.firebaseHelpers.showAlert('Error loading equipment details', 'danger');
        }
    }

    // Edit equipment
    async function editEquipment(equipmentId) {
        window.firebaseHelpers.showAlert('Edit feature coming soon!', 'info');
    }

    // Delete equipment
    async function deleteEquipment(equipmentId) {
        if (!confirm('Are you sure you want to delete this equipment?')) {
            return;
        }
        
        try {
            await window.FirebaseDB.collection('equipment').doc(equipmentId).delete();
            window.firebaseHelpers.showAlert('Equipment deleted successfully', 'success');
            loadEquipmentList();
        } catch (error) {
            console.error('Error deleting equipment:', error);
            window.firebaseHelpers.showAlert('Error deleting equipment', 'danger');
        }
    }

    // View order details
    async function viewOrderDetails(orderId) {
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const orderRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders').doc(orderId);
            const doc = await orderRef.get();

            if (doc.exists) {
                const order = doc.data();
                
                // Format dates
                const createdAt = window.firebaseHelpers.formatDateTime(order.createdAt);
                
                // Extract rental details from items (assuming first item for simplicity)
                const firstItem = order.items?.[0];
                const rentalPeriod = firstItem ? `${firstItem.rentalValue} ${firstItem.rentalType === 'acre' ? 'Acres' : 'Hours'}` : 'N/A';

                // Create modal content
                const modalBody = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Order Information</h5>
                            <table class="table table-sm">
                                <tr><th>Order ID:</th><td>#${orderId.substring(0, 8)}</td></tr>
                                <tr><th>Status:</th><td><span class="status-badge order-status-${order.status}">${order.status}</span></td></tr>
                                <tr><th>Created:</th><td>${createdAt}</td></tr>
                                <tr><th>Total Amount:</th><td>${window.firebaseHelpers.formatCurrency(order.totalAmount || 0)}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Rental Details</h5>
                            <table class="table table-sm">
                                <tr><th>Equipment:</th><td>${order.equipmentNames || 'N/A'}</td></tr>
                                <tr><th>Rental Period:</th><td>${rentalPeriod}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5>Customer Information</h5>
                            <table class="table table-sm">
                                <tr><th>Name:</th><td>${order.customerName || 'N/A'}</td></tr>
                                <tr><th>Phone:</th><td>${order.customerPhone || 'N/A'}</td></tr>
                                <tr><th>Email:</th><td>${order.customerEmail || 'N/A'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Payment Information</h5>
                            <table class="table table-sm">
                                <tr><th>Payment Status:</th><td>${order.paymentStatus || 'pending'}</td></tr>
                                <tr><th>Payment Method:</th><td>${order.paymentMethod || 'Razorpay'}</td></tr>
                                <tr><th>Transaction ID:</th><td>${order.transactionId || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    ${order.notes ? `
                        <div class="mt-3">
                            <h5>Additional Notes</h5>
                            <p>${order.notes}</p>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('order-modal-body').innerHTML = modalBody;
                const modal = new bootstrap.Modal(document.getElementById('orderModal'));
                modal.show();
            }
        } catch (error) {
            console.error('Error viewing order:', error);
            window.firebaseHelpers.showAlert('Error loading order details', 'danger');
        }
    }

    // Update order status
    async function updateOrderStatus(orderId, newStatus) {
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const orderRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders').doc(orderId);
            
            await orderRef.update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            window.firebaseHelpers.showAlert(`Order ${newStatus} successfully!`, 'success');
            loadRecentOrders();
            loadOrders();
            
        } catch (error) {
            console.error('Error updating order:', error);
            window.firebaseHelpers.showAlert('Error updating order status', 'danger');
        }
    }

    // Load earnings data
    async function loadEarningsData() {
        if (!currentUser) return;
        
        try {
            // Calculate monthly earnings
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const ordersCollectionRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');
            
            const ordersSnapshot = await ordersCollectionRef
                .where('sellerIds', 'array-contains', currentUser.uid)
                .where('status', 'in', ['completed', 'active'])
                .get();
            
            let thisMonthEarnings = 0;
            let lastMonthEarnings = 0;
            const monthlyEarnings = new Array(12).fill(0);
            
            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                const orderDate = order.createdAt ? order.createdAt.toDate() : new Date();
                const month = orderDate.getMonth();
                const year = orderDate.getFullYear();
                
                // NOTE: This assumes the totalAmount is the seller's gross earning. 
                // In a real app, earnings would be stored per-seller per-item in the order.
                const amount = order.totalAmount || 0; 
                
                if (year === currentYear) {
                    monthlyEarnings[month] += amount;
                    
                    if (month === currentMonth) {
                        thisMonthEarnings += amount;
                    } else if (month === currentMonth - 1 || (currentMonth === 0 && month === 11)) {
                        lastMonthEarnings += amount;
                    }
                }
            });
            
            // Update UI
            document.getElementById('month-earnings').textContent = window.firebaseHelpers.formatCurrency(thisMonthEarnings);
            document.getElementById('last-month-earnings').textContent = window.firebaseHelpers.formatCurrency(lastMonthEarnings);
            
            const growth = lastMonthEarnings > 0 ? ((thisMonthEarnings - lastMonthEarnings) / lastMonthEarnings * 100).toFixed(1) : (thisMonthEarnings > 0 ? 100 : 0);
            document.getElementById('month-growth').textContent = `${growth}% from last month`;
            document.getElementById('month-growth').className = parseFloat(growth) >= 0 ? 'text-success' : 'text-danger';
            
            // Update chart
            updateDetailedEarningsChart(monthlyEarnings);
            
            // Load top equipment
            await loadTopEquipment();
            
        } catch (error) {
            console.error('Error loading earnings data:', error);
        }
    }

    // Update detailed earnings chart
    function updateDetailedEarningsChart(monthlyEarnings) {
        const ctx = document.getElementById('detailedEarningsChart').getContext('2d');
        
        if (detailedEarningsChart) {
            detailedEarningsChart.destroy();
        }
        
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        detailedEarningsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Monthly Earnings (₹)',
                    data: monthlyEarnings,
                    backgroundColor: '#2B5C2B',
                    borderColor: '#1e4a1e',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Load top equipment
    async function loadTopEquipment() {
        try {
            // Fetch all equipment belonging to the seller
            const equipmentSnapshot = await window.FirebaseDB.collection('equipment')
                .where('sellerId', '==', currentUser.uid)
                .get();
            
            const equipmentEarnings = {};
            const equipmentNames = {};
            
            equipmentSnapshot.forEach(doc => {
                equipmentEarnings[doc.id] = 0;
                equipmentNames[doc.id] = doc.data().name;
            });

            // Fetch all relevant orders
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const ordersCollectionRef = window.FirebaseDB.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');
            
            const ordersSnapshot = await ordersCollectionRef
                .where('sellerIds', 'array-contains', currentUser.uid)
                .where('status', 'in', ['completed', 'active'])
                .get();

            // Aggregate earnings per equipment
            ordersSnapshot.forEach(orderDoc => {
                const order = orderDoc.data();
                order.items.forEach(item => {
                    // Only count earnings for equipment belonging to this seller
                    if (item.sellerId === currentUser.uid && equipmentEarnings[item.id] !== undefined) {
                        equipmentEarnings[item.id] += item.price || 0; // Item price is the amount paid for that item rental
                    }
                });
            });
            
            // Format for display
            const topEquipment = Object.entries(equipmentEarnings)
                .map(([id, earnings]) => ({
                    name: equipmentNames[id],
                    earnings: earnings
                }))
                .filter(item => item.earnings > 0)
                .sort((a, b) => b.earnings - a.earnings)
                .slice(0, 5);
            
            // Update UI
            const topEquipmentList = document.getElementById('top-equipment-list');
            if (topEquipment.length === 0) {
                topEquipmentList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                        <p>No earnings data yet</p>
                    </div>
                `;
                return;
            }
            
            topEquipmentList.innerHTML = topEquipment.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                    <div>
                        <h6 class="mb-1">${item.name}</h6>
                    </div>
                    <div class="text-end">
                        <strong>${window.firebaseHelpers.formatCurrency(item.earnings)}</strong>
                    </div>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Error loading top equipment:', error);
        }
    }

    // Load messages (REMOVED MOCK DATA IN JS)
    async function loadMessages() {
        // In a real application, this would fetch real-time chat data from Firestore.
        // For now, only the static UI remains.
        const conversationsList = document.getElementById('conversations-list');
        conversationsList.innerHTML = `
             <div class="text-center py-5 text-muted">
                <i class="fas fa-comment-dots fa-3x mb-3"></i>
                <p>Chat feature coming soon.</p>
            </div>
        `;
        document.getElementById('chat-messages').innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>Select a conversation to view messages</p>
            </div>
        `;
        document.getElementById('chat-header').innerHTML = '<h5>Messages</h5><p class="text-muted mb-0">No active conversations</p>';
        document.getElementById('chat-input').style.display = 'none';

        // NOTE: The UI still shows "3" messages in the sidebar badge (hardcoded in HTML)
        // You would typically update this dynamically based on unread counts.
    }

    // Open conversation (REMOVED MOCK DATA IN JS)
    function openConversation(conversationId) {
        window.firebaseHelpers.showAlert('Chat feature coming soon! Cannot open conversation.', 'info');
        document.getElementById('chat-header').innerHTML = `
            <h5>Customer Chat</h5>
            <p class="text-muted mb-0">Simulated conversation</p>
        `;
        
        document.getElementById('chat-messages').innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-code fa-3x mb-3"></i>
                <p>This is a placeholder chat window. The messaging feature is not fully implemented.</p>
            </div>
        `;
        
        document.getElementById('chat-input').style.display = 'block';
    }

    // Send message (REMOVED MOCK DATA IN JS)
    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (message) {
             window.firebaseHelpers.showAlert('Message sent (simulated). Chat feature is not fully implemented.', 'info');
             input.value = '';
        }
    }

    // Load reviews
    async function loadReviews() {
        try {
            const reviewsSnapshot = await window.FirebaseDB.collection('reviews')
                .where('sellerId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .get();
            
            let totalRating = 0;
            let ratingCount = 0;
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = '';
            
            if (reviewsSnapshot.empty) {
                reviewsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-star fa-3x text-muted mb-3"></i>
                        <h4>No reviews yet</h4>
                        <p class="text-muted">You haven't received any reviews yet</p>
                    </div>
                `;
                return;
            }
            
            reviewsSnapshot.forEach(doc => {
                const review = doc.data();
                totalRating += review.rating || 0;
                ratingCount++;
                
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                const date = window.firebaseHelpers.formatDate(review.createdAt);
                
                reviewsList.innerHTML += `
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${review.customerName || 'Customer'}</h6>
                                <div class="text-warning">${stars}</div>
                            </div>
                            <small class="text-muted">${date}</small>
                        </div>
                        <p class="mb-2">${review.comment || 'No comment'}</p>
                        <small class="text-muted">For: ${review.equipmentName || 'Equipment'}</small>
                    </div>
                `;
            });
            
            // Update average rating
            const averageRating = ratingCount > 0 ? totalRating / ratingCount : 0;
            document.getElementById('average-rating').textContent = averageRating.toFixed(1);
            
            // Update star icons based on average rating
            const starContainer = document.querySelector('#reviews-section .table-container .mb-2');
            const fullStars = Math.round(averageRating);
            const emptyStars = 5 - fullStars;
            starContainer.innerHTML = '';
            for (let i = 0; i < fullStars; i++) {
                starContainer.innerHTML += '<i class="fas fa-star text-warning"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starContainer.innerHTML += '<i class="far fa-star text-warning"></i>';
            }

            document.getElementById('total-reviews').textContent = `${ratingCount} reviews`;
            
        } catch (error) {
            console.error('Error loading reviews:', error);
        }
    }

    // Load profile data
    async function loadProfileData() {
        if (!sellerData) return;
        
        // Populate form fields
        document.getElementById('profile-name').value = sellerData.name || '';
        document.getElementById('profile-email').value = sellerData.email || '';
        document.getElementById('profile-phone').value = sellerData.mobile || '';
        document.getElementById('profile-business').value = sellerData.businessName || '';
        document.getElementById('profile-address').value = sellerData.address || '';
        document.getElementById('profile-gst').value = sellerData.gstNumber || '';
        document.getElementById('profile-city').value = sellerData.city || '';
        document.getElementById('profile-bio').value = sellerData.bio || '';
        
        // Update profile picture if exists
        if (sellerData.profilePicture) {
            document.getElementById('profile-picture').src = sellerData.profilePicture;
        }
        
        // Update join date
        if (sellerData.createdAt) {
            const joinDate = window.firebaseHelpers.formatDate(sellerData.createdAt);
            document.getElementById('join-date').textContent = joinDate;
        }
    }

    // Profile form submission
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentUser) return;
        
        try {
            const updates = {
                name: document.getElementById('profile-name').value,
                mobile: document.getElementById('profile-phone').value,
                businessName: document.getElementById('profile-business').value,
                address: document.getElementById('profile-address').value,
                gstNumber: document.getElementById('profile-gst').value,
                city: document.getElementById('profile-city').value,
                bio: document.getElementById('profile-bio').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Update password if provided
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword || currentPassword || confirmPassword) {
                if (!currentPassword) {
                    window.firebaseHelpers.showAlert('Please enter your current password to change it.', 'danger');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    window.firebaseHelpers.showAlert('New passwords do not match', 'danger');
                    return;
                }
                if (newPassword.length < 6) {
                    window.firebaseHelpers.showAlert('New password must be at least 6 characters long', 'danger');
                    return;
                }
                
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                await currentUser.updatePassword(newPassword);
                window.firebaseHelpers.showAlert('Password updated successfully', 'success');
                
                // Clear password fields
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            }
            
            // Update Firestore
            await window.FirebaseDB.collection('users').doc(currentUser.uid).update(updates);
            
            // Update local seller data
            sellerData = { ...sellerData, ...updates };
            updateSellerInfo();
            
            window.firebaseHelpers.showAlert('Profile updated successfully', 'success');
            
        } catch (error) {
            console.error('Error updating profile:', error);
            window.firebaseHelpers.showAlert('Error updating profile: ' + error.message, 'danger');
        }
    });

    // Show delete account modal
    function showDeleteAccountModal() {
        const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
        modal.show();
        
        // Enable/disable delete button based on confirmation
        document.getElementById('delete-confirmation').addEventListener('input', function() {
            document.getElementById('delete-account-btn').disabled = 
                this.value !== 'DELETE';
        });
    }

    // Delete account
    async function deleteAccount() {
        if (!currentUser) return;
        
        try {
            // Delete user data from Firestore
            await window.FirebaseDB.collection('users').doc(currentUser.uid).delete();
            
            // Delete user's equipment
            const equipmentSnapshot = await window.FirebaseDB.collection('equipment')
                .where('sellerId', '==', currentUser.uid)
                .get();
            
            const deletePromises = equipmentSnapshot.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
            
            // Delete user from Firebase Auth
            await currentUser.delete();
            
            // Clear local storage
            localStorage.removeItem('currentUser');
            
            window.firebaseHelpers.showAlert('Account deleted successfully', 'success');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
        } catch (error) {
            console.error('Error deleting account:', error);
            window.firebaseHelpers.showAlert('Error deleting account: ' + error.message, 'danger');
        }
    }

    // Logout function
    async function logout() {
        try {
            await window.firebaseHelpers.signOut();
            window.location.href = 'index.html';
        } catch (error) {
            console.error('Logout error:', error);
            window.firebaseHelpers.showAlert('Error logging out', 'danger');
        }
    }

    // Handle image upload preview
    document.getElementById('image-upload').addEventListener('change', function(e) {
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.margin = '5px';
                img.style.borderRadius = '5px';
                preview.appendChild(img);
            }
            
            reader.readAsDataURL(file);
        }
    });

    // Handle profile picture upload
    document.getElementById('profile-picture-upload').addEventListener('change', async function(e) {
        if (this.files[0]) {
            try {
                const file = this.files[0];
                
                // Show loading placeholder
                const profilePic = document.getElementById('profile-picture');
                profilePic.src = 'https://via.placeholder.com/100?text=Uploading...';
                
                // Use the new ImgBB helper
                const downloadURL = await window.firebaseHelpers.uploadFile(
                    `profile_pictures/${currentUser.uid}`, // Path is passed but ignored by the new helper
                    file
                );
                
                // Update profile picture in Firestore
                await window.FirebaseDB.collection('users').doc(currentUser.uid).update({
                    profilePicture: downloadURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local data and UI
                sellerData.profilePicture = downloadURL;
                profilePic.src = downloadURL;
                
                window.firebaseHelpers.showAlert('Profile picture updated successfully', 'success');
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                window.firebaseHelpers.showAlert('Error uploading profile picture. ' + error.message, 'danger');
                
                // Restore original picture or default placeholder on failure
                const currentSellerData = await window.FirebaseDB.collection('users').doc(currentUser.uid).get();
                const restoredSrc = currentSellerData.data()?.profilePicture || 'https://via.placeholder.com/100';
                document.getElementById('profile-picture').src = restoredSrc;
            }
        }
    });

    // Initialize dashboard on load
    showSection('dashboard');
</script>
    
</body>
</html>
