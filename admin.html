<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FarmRent</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --farm-green: #2B5C2B;
            --earth-brown: #8B4513;
            --sun-yellow: #F2C14E;
            --accent-red: #D0614C;
            --clean-white: #F7F7F7;
            --text-dark: #333;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f8f9fa;
            color: var(--text-dark);
            overflow-x: hidden;
        }
        
        /* Sidebar Styles - Matching Seller Dashboard */
        .sidebar {
            background: linear-gradient(180deg, var(--farm-green), #1e4a1e);
            color: white;
            height: 100vh;
            position: fixed;
            width: 280px;
            padding-top: 20px;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: transform 0.3s;
        }
        
        .sidebar.collapsed {
            transform: translateX(-280px);
        }
        
        .sidebar-header {
            padding: 0 25px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h3 {
            color: var(--sun-yellow);
            font-weight: 700;
            font-size: 1.4rem;
        }
        
        .admin-badge {
            background: var(--sun-yellow);
            color: var(--farm-green);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.85);
            padding: 14px 25px;
            margin: 5px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: var(--sun-yellow);
            color: var(--farm-green);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .nav-badge {
            background: var(--accent-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }
        
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
        }
        
        /* Main Content Styles */
        .main-content {
            margin-left: 280px;
            padding: 0;
            min-height: 100vh;
            transition: margin-left 0.3s;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* Top Navbar */
        .navbar-admin {
            background: white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 999;
            border-bottom: 1px solid #eee;
        }
        
        .navbar-toggler-custom {
            background: none;
            border: none;
            color: var(--farm-green);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .navbar-toggler-custom:hover {
            background: #f0f0f0;
        }
        
        .search-bar {
            max-width: 400px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            padding: 8px 20px;
        }
        
        .search-bar:focus {
            background: white;
            border-color: var(--farm-green);
            box-shadow: 0 0 0 3px rgba(43, 92, 43, 0.1);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }
        
        /* Color themes for cards */
        .stat-card.users::before { background: var(--farm-green); }
        .stat-card.sellers::before { background: var(--earth-brown); }
        .stat-card.equipment::before { background: var(--sun-yellow); }
        .stat-card.orders::before { background: var(--accent-red); }
        .stat-card.earnings::before { background: #2196f3; }
        .stat-card.revenue::before { background: #9c27b0; }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        /* Icon backgrounds matching seller dashboard feel */
        .stat-card.users .stat-icon { background: rgba(43, 92, 43, 0.1); color: var(--farm-green); }
        .stat-card.sellers .stat-icon { background: rgba(139, 69, 19, 0.1); color: var(--earth-brown); }
        .stat-card.equipment .stat-icon { background: rgba(242, 193, 78, 0.2); color: #d4a017; }
        .stat-card.orders .stat-icon { background: rgba(208, 97, 76, 0.1); color: var(--accent-red); }
        .stat-card.earnings .stat-icon { background: rgba(33, 150, 243, 0.1); color: #2196f3; }
        .stat-card.revenue .stat-icon { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        /* Section Container */
        .section-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title {
            color: var(--farm-green);
            font-weight: 700;
            font-size: 1.3rem;
            margin: 0;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th {
            background: #f8f9fa;
            color: var(--farm-green);
            font-weight: 600;
            padding: 15px;
            border-bottom: 2px solid #e0e0e0;
            text-align: left;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background: #fcfcfc;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-active, .status-approved { background: #e8f5e9; color: #2e7d32; }
        .status-pending { background: #fff3e0; color: #ef6c00; }
        .status-suspended, .status-rejected { background: #ffebee; color: #c62828; }
        
        /* Buttons */
        .btn-primary { background-color: var(--farm-green); border-color: var(--farm-green); }
        .btn-primary:hover { background-color: #1e4a1e; border-color: #1e4a1e; }
        .btn-outline-primary { color: var(--farm-green); border-color: var(--farm-green); }
        .btn-outline-primary:hover { background-color: var(--farm-green); color: white; }
        .btn-outline-primary.active { background-color: var(--farm-green); color: white; border-color: var(--farm-green); }

        /* Action Buttons */
        .action-btn {
            width: 36px; height: 36px; border-radius: 8px;
            display: inline-flex; align-items: center; justify-content: center;
            border: none; background: transparent; transition: all 0.2s; cursor: pointer;
        }
        .action-btn:hover { transform: scale(1.1); }
        .action-view { color: var(--farm-green); background: rgba(43, 92, 43, 0.1); }
        .action-edit { color: var(--sun-yellow); background: rgba(242, 193, 78, 0.2); color: #b8860b; }
        .action-delete { color: var(--accent-red); background: rgba(208, 97, 76, 0.1); }
        .action-approve { color: white; background: var(--farm-green); }
        
        /* Chart Wrapper */
        .chart-wrapper {
            background: white; border-radius: 12px; padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05); height: 100%;
        }

        /* Loading */
        .loading { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--farm-green); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Quick Stats */
        .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .quick-stat { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .quick-stat:hover { transform: translateY(-3px); }
        .quick-stat-value { font-size: 1.8rem; font-weight: 700; color: var(--farm-green); margin-bottom: 5px; }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar { transform: translateX(-280px); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-tractor me-2"></i>FarmRent</h3>
                <span class="admin-badge">ADMIN</span>
            </div>
            <div class="text-muted" style="color: rgba(255,255,255,0.7) !important; font-size: 0.9rem;">
                <i class="fas fa-user-shield me-2"></i>
                <span id="admin-name">Administrator</span>
            </div>
        </div>
        
        <nav class="nav flex-column mt-4">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="#" onclick="showSection('users')">
                <i class="fas fa-users"></i> Users
                <span class="nav-badge" id="pending-users-count" style="display:none">0</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('sellers')">
                <i class="fas fa-store"></i> Sellers
                <span class="nav-badge" id="pending-sellers-count">0</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('equipment')">
                <i class="fas fa-tractor"></i> Equipment
                <span class="nav-badge" id="pending-equipment-count">0</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('orders')">
                <i class="fas fa-shopping-cart"></i> Orders
            </a>
            <a class="nav-link" href="#" onclick="showSection('reports')">
                <i class="fas fa-chart-bar"></i> Analytics
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="d-grid gap-2">
                <button class="btn btn-warning" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navbar -->
        <nav class="navbar-admin">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div class="d-flex align-items-center gap-3">
                    <button class="navbar-toggler-custom" id="sidebarToggler">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h4 class="mb-0" id="page-title">Dashboard</h4>
                        <p class="text-muted mb-0" id="page-subtitle">Overview & Statistics</p>
                    </div>
                </div>
                
                <div class="d-flex align-items-center gap-3">
                    <div class="dropdown">
                         <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            <span id="admin-short-name">Admin</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="index.html"><i class="fas fa-home me-2"></i>Home Site</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="container-fluid py-4">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p class="mt-3">Loading live data...</p>
            </div>

            <!-- Dashboard Section -->
            <div class="section" id="dashboard-section" style="display:none;">
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="total-users">0</div>
                        <div class="quick-stat-label">Total Users</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="total-sellers">0</div>
                        <div class="quick-stat-label">Active Sellers</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="total-equipment">0</div>
                        <div class="quick-stat-label">Total Equipment</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="total-revenue">₹0</div>
                        <div class="quick-stat-label">Total Platform Revenue</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-lg-8 mb-4">
                        <div class="chart-wrapper">
                            <h5 class="section-title mb-3">Recent Revenue Trend</h5>
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="chart-wrapper">
                            <h5 class="section-title mb-3">User Distribution</h5>
                            <canvas id="userChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pending Actions Row -->
                 <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="section-container">
                            <div class="section-header">
                                <h5 class="section-title">Pending Seller Approvals</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="showSection('sellers')">View All</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead><tr><th>Name</th><th>Business</th><th>Date</th><th>Action</th></tr></thead>
                                    <tbody id="pending-sellers-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="section-container">
                             <div class="section-header">
                                <h5 class="section-title">Pending Equipment</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="showSection('equipment')">View All</button>
                            </div>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead><tr><th>Item</th><th>Seller</th><th>Price</th><th>Action</th></tr></thead>
                                    <tbody id="pending-equipment-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Other Sections Placeholders (Logic handles visibility) -->
            <div class="section" id="users-section" style="display:none;">
                <div class="section-container">
                    <h5 class="section-title mb-4">Users Management</h5>
                    <div class="table-responsive"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Joined</th></tr></thead><tbody id="all-users-table"></tbody></table></div>
                </div>
            </div>
            
            <div class="section" id="sellers-section" style="display:none;">
                 <div class="section-container">
                    <h5 class="section-title mb-4">Sellers Management</h5>
                    <div class="table-responsive"><table class="data-table"><thead><tr><th>Business</th><th>Owner</th><th>Status</th><th>Actions</th></tr></thead><tbody id="all-sellers-table"></tbody></table></div>
                </div>
            </div>
            
             <div class="section" id="equipment-section" style="display:none;">
                 <div class="section-container">
                    <h5 class="section-title mb-4">Equipment Management</h5>
                    <div class="table-responsive"><table class="data-table"><thead><tr><th>Item</th><th>Category</th><th>Seller</th><th>Status</th><th>Actions</th></tr></thead><tbody id="all-equipment-table"></tbody></table></div>
                </div>
            </div>
            
             <div class="section" id="orders-section" style="display:none;">
                 <div class="section-container">
                    <h5 class="section-title mb-4">All Orders</h5>
                    <div class="table-responsive"><table class="data-table"><thead><tr><th>Order ID</th><th>Customer</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody id="all-orders-table"></tbody></table></div>
                </div>
            </div>
            
             <div class="section" id="reports-section" style="display:none;">
                 <div class="section-container text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5>Advanced Analytics</h5>
                    <p class="text-muted">Detailed reports are generated based on real-time data.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentUser = null;
        let db = null;
        let revenueChart = null;
        let userChart = null;

        document.addEventListener('DOMContentLoaded', async () => {
            db = firebase.firestore();
            
            // Check Auth
            const authCheck = await window.firebaseHelpers.checkAuthAndRole('admin');
            if (!authCheck.authenticated) { window.location.href = 'auth.html?role=admin'; return; }
            if (!authCheck.authorized) { window.location.href = 'index.html'; return; }
            
            currentUser = authCheck.user;
            document.getElementById('admin-name').textContent = currentUser.name || 'Admin';
            
            // Initial Load
            initializeSidebar();
            showSection('dashboard');
        });

        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            document.getElementById('sidebarToggler').addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(sectionId + '-section');
            if(target) target.style.display = 'block';
            
            // Update Active Nav
            const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(l => l.getAttribute('onclick').includes(sectionId));
            if(activeLink) activeLink.classList.add('active');

            // Load Data
            if(sectionId === 'dashboard') loadDashboard();
            else if(sectionId === 'users') loadUsers();
            else if(sectionId === 'sellers') loadSellers();
            else if(sectionId === 'equipment') loadEquipment();
            else if(sectionId === 'orders') loadOrders();
        }

        async function loadDashboard() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('dashboard-section').style.display = 'none';

            try {
                // Fetch basic counts
                const usersSnap = await db.collection('users').get();
                const equipSnap = await db.collection('equipment').get();
                const orderSnap = await db.collection('orders').get();

                let customers = 0, sellers = 0, admins = 0, activeSellers = 0;
                let pendingSellers = [];
                
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    if(u.role === 'customer') customers++;
                    if(u.role === 'seller') {
                        sellers++;
                        if(u.status === 'approved') activeSellers++;
                        if(u.status === 'pending') pendingSellers.push({id: doc.id, ...u});
                    }
                    if(u.role === 'admin') admins++;
                });

                let totalRevenue = 0;
                let pendingEquipment = [];
                
                orderSnap.forEach(doc => {
                    const o = doc.data();
                    if(o.status !== 'cancelled') totalRevenue += (o.totalAmount || 0);
                });

                equipSnap.forEach(doc => {
                    const e = doc.data();
                    if(e.status === 'pending') pendingEquipment.push({id: doc.id, ...e});
                });

                // Update UI Stats
                document.getElementById('total-users').innerText = usersSnap.size;
                document.getElementById('total-sellers').innerText = activeSellers;
                document.getElementById('total-equipment').innerText = equipSnap.size;
                document.getElementById('total-revenue').innerText = window.firebaseHelpers.formatCurrency(totalRevenue);
                
                // Update Sidebar Badges
                document.getElementById('pending-sellers-count').innerText = pendingSellers.length;
                document.getElementById('pending-equipment-count').innerText = pendingEquipment.length;

                // Populate Pending Tables
                renderPendingSellers(pendingSellers.slice(0, 5));
                renderPendingEquipment(pendingEquipment.slice(0, 5));
                
                // Render Charts
                renderCharts(customers, sellers, admins, orderSnap);

            } catch (error) {
                console.error("Dashboard Load Error", error);
                window.firebaseHelpers.showAlert("Error loading live data", "danger");
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
            }
        }

        function renderPendingSellers(sellers) {
            const tbody = document.getElementById('pending-sellers-table');
            tbody.innerHTML = sellers.length ? '' : '<tr><td colspan="4" class="text-center text-muted">No pending approvals</td></tr>';
            sellers.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.businessName || 'N/A'}</td>
                        <td>${window.firebaseHelpers.formatDate(s.createdAt)}</td>
                        <td>
                            <button class="action-btn action-approve" onclick="updateStatus('users', '${s.id}', 'approved')"><i class="fas fa-check"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function renderPendingEquipment(equip) {
            const tbody = document.getElementById('pending-equipment-table');
            tbody.innerHTML = equip.length ? '' : '<tr><td colspan="4" class="text-center text-muted">No pending equipment</td></tr>';
            equip.forEach(e => {
                tbody.innerHTML += `
                    <tr>
                        <td>${e.name}</td>
                        <td>${e.sellerName || 'Unknown'}</td>
                        <td>${e.pricePerDay}/day</td>
                        <td>
                            <button class="action-btn action-approve" onclick="updateStatus('equipment', '${e.id}', 'approved')"><i class="fas fa-check"></i></button>
                        </td>
                    </tr>`;
            });
        }

        async function updateStatus(collection, id, status) {
            if(!confirm(`Mark this as ${status}?`)) return;
            try {
                await db.collection(collection).doc(id).update({ status: status });
                showSection('dashboard'); // Refresh
                window.firebaseHelpers.showAlert('Updated successfully', 'success');
            } catch (e) {
                console.error(e);
                window.firebaseHelpers.showAlert('Update failed', 'danger');
            }
        }
        
        async function logout() {
            await window.firebaseHelpers.signOut();
            window.location.href = 'index.html';
        }

        function renderCharts(cust, sell, adm, orders) {
            // User Chart
            const ctxUser = document.getElementById('userChart').getContext('2d');
            if(userChart) userChart.destroy();
            userChart = new Chart(ctxUser, {
                type: 'doughnut',
                data: {
                    labels: ['Customers', 'Sellers', 'Admins'],
                    datasets: [{
                        data: [cust, sell, adm],
                        backgroundColor: ['#2B5C2B', '#8B4513', '#F2C14E']
                    }]
                }
            });

            // Revenue Chart (Simple aggregation by date for demo of dynamic capability)
            // In a real production app with massive data, rely on backend aggregation.
            // Here we aggregate loaded orders for demonstration.
            const revenueByDate = {};
            orders.forEach(doc => {
                const o = doc.data();
                if(o.createdAt && o.status !== 'cancelled') {
                    const date = new Date(o.createdAt.seconds * 1000).toLocaleDateString();
                    revenueByDate[date] = (revenueByDate[date] || 0) + (o.totalAmount || 0);
                }
            });
            
            const labels = Object.keys(revenueByDate).slice(-7); // Last 7 entries
            const data = Object.values(revenueByDate).slice(-7);

            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            if(revenueChart) revenueChart.destroy();
            
            // If empty, show empty state
            if(labels.length === 0) {
                 // Empty placeholder chart
                 revenueChart = new Chart(ctxRev, {
                    type: 'line',
                    data: { labels: ['No Data'], datasets: [{ label: 'Revenue', data: [0] }] }
                 });
            } else {
                revenueChart = new Chart(ctxRev, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue (₹)',
                            data: data,
                            borderColor: '#2B5C2B',
                            backgroundColor: 'rgba(43, 92, 43, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }
        }

        // --- Loaders for Full Tables (Simplified implementation) ---
        async function loadUsers() {
             const snap = await db.collection('users').limit(20).get();
             const tbody = document.getElementById('all-users-table');
             tbody.innerHTML = '';
             snap.forEach(doc => {
                 const u = doc.data();
                 tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td><span class="status-badge status-${u.status || 'active'}">${u.role}</span></td><td>${window.firebaseHelpers.formatDate(u.createdAt)}</td></tr>`;
             });
        }
        
        async function loadSellers() {
             const snap = await db.collection('users').where('role', '==', 'seller').get();
             const tbody = document.getElementById('all-sellers-table');
             tbody.innerHTML = '';
             snap.forEach(doc => {
                 const u = doc.data();
                 tbody.innerHTML += `<tr><td>${u.businessName}</td><td>${u.name}</td><td><span class="status-badge status-${u.status}">${u.status}</span></td><td><button class="btn btn-sm btn-outline-primary" onclick="updateStatus('users','${doc.id}','approved')">Approve</button></td></tr>`;
             });
        }
        
        async function loadEquipment() {
             const snap = await db.collection('equipment').orderBy('createdAt', 'desc').limit(20).get();
             const tbody = document.getElementById('all-equipment-table');
             tbody.innerHTML = '';
             snap.forEach(doc => {
                 const e = doc.data();
                 tbody.innerHTML += `<tr><td>${e.name}</td><td>${e.category}</td><td>${e.sellerName}</td><td><span class="status-badge status-${e.status}">${e.status}</span></td><td><button class="btn btn-sm btn-outline-danger" onclick="updateStatus('equipment','${doc.id}','rejected')">Reject</button></td></tr>`;
             });
        }

        async function loadOrders() {
             const snap = await db.collection('orders').orderBy('createdAt', 'desc').limit(20).get();
             const tbody = document.getElementById('all-orders-table');
             tbody.innerHTML = '';
             snap.forEach(doc => {
                 const o = doc.data();
                 tbody.innerHTML += `<tr><td>#${doc.id.substr(0,8)}</td><td>${o.customerName}</td><td>₹${o.totalAmount}</td><td><span class="status-badge status-${o.status}">${o.status}</span></td><td>${window.firebaseHelpers.formatDate(o.createdAt)}</td></tr>`;
             });
        }
    </script>
</body>
</html>
